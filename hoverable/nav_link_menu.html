<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>導覽列範例-連結可展開懸浮子選單</title>
  <style>
    :root{
      --ink:#190b63;
      --nav-bg:#190b63;
      --dropdown-bg:#281683;
      --accent:#086480;
      --focus:#0a63ff;
    }
    html,body{margin:0;padding:0}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans TC",sans-serif;color:var(--ink);padding:2rem}

    *:focus-visible{
      outline:3px solid var(--focus);
      outline-offset:2px;
      border-radius:4px;
      box-shadow:0 0 0 4px #fff;
    }

    .skip-link{
      position:absolute;left:12px;top:0;transform:translateY(-150%);
      padding:12px 16px;background:#fff;border:2px solid var(--focus);
      border-radius:8px;text-decoration:none;color:var(--ink);
      font-weight:600;z-index:1000;
    }
    .skip-link:focus,.skip-link:focus-visible{transform:translateY(10px);}
    h1{margin-top:40px;}
    .haspopup_inside{margin-top:200px;}

    .navbar{background-color:var(--nav-bg);color:#fff;margin-bottom:24px;}
    .navbar .container{
      max-width:1200px;margin:0 auto;padding:0 16px;min-height:80px;
      display:flex;align-items:center;justify-content:space-between;
    }
    .logo{display:flex;align-items:center;gap:10px}
    .logo .mark{width:24px;height:24px;background:#fff;border-radius:4px}

    .menu{list-style:none;margin:0;padding:0;display:flex;gap:0}
    .menu>li{position:relative}
    .menu>li>a,.menu>li>button{
      color:#fff;background:transparent;border:0;display:block;line-height:24px;
      padding:28px 16px;margin-right:4px;text-decoration:none;font:inherit;cursor:pointer;
    }

    .menu>li>a:hover,.menu>li>button:hover{background:var(--accent);}

    .menu>li>.menuButton::after{
      content:"▾";margin-left:6px;font-size:.8em;line-height:1;opacity:.9;
    }
    .menu>li>.menuButton[aria-expanded="true"]{background:var(--accent);}
    .menu>li>.menuButton[aria-expanded="true"]::after{content:"▴";}

    .menuList{
      position:absolute;top:100%;left:0;width:200px;border:1px solid rgba(255,255,255,.2);
      background:var(--dropdown-bg);list-style:none;margin:0;padding:8px 0;
      box-shadow:0 2px 6px rgba(0,0,0,.15);
    }
    .menuList[hidden]{display:none}
    .menuList li a{
      display:block;width:100%;padding:8px 24px;line-height:24px;color:#fff;text-decoration:none;
    }
    .menuList li a:hover{background:var(--accent)}
    .menuList li a:focus-visible{background:var(--accent);}
  </style>
</head>
<body>
  <a href="#mainh1" class="skip-link">跳到主要內容區</a>
  <main>
    <h1 id="mainh1">連結選單範例</h1>

    <h2 tabindex="0">第一類：含有aria-haspopup(子功能表)</h2>
    <nav class="navbar" aria-label="主選單 第一類">
      <div class="container">
        <div class="logo" aria-label="網站標誌">
          <div class="mark" aria-hidden="true"></div>
          <span>示範元件</span>
        </div>
        <ul class="menu">
          <li><a href="https://accessibility.moda.gov.tw/Applications/Index/1?EnableId2=3">標章查詢</a></li>
          <li>
            <a href="https://accessibility.moda.gov.tw/Questions"
               class="menuButton"
               data-focus-mode="stay"
               aria-haspopup="menu"
               aria-expanded="false"
               aria-controls="menuList-1"
               aria-label="常見問題">
              常見問題
            </a>
            <ul class="menuList" id="menuList-1" hidden>
              <li><a href="https://accessibility.moda.gov.tw/Questions/Category/18/1">標章申請及異動</a></li>
              <li><a href="https://accessibility.moda.gov.tw/Questions/Category/33/1">無障礙網頁規範</a></li>
              <li><a href="https://accessibility.moda.gov.tw/Questions/Category/19/1">網頁設計與規範要求</a></li>
              <li><a href="https://accessibility.moda.gov.tw/Questions/Category/20/1">Freego 檢測問題</a></li>
            </ul>
          </li>
          <li><a class="about-link" href="https://accessibility.moda.gov.tw/Applications/Index/1?EnableId2=3">關於無障礙</a></li>
          <li><a href="https://accessibility.moda.gov.tw/Download">下載專區</a></li>
        </ul>
      </div>
    </nav>

    <h2 class="haspopup_inside" tabindex="0">第二類：無aria-haspopup</h2>
    <nav class="navbar" aria-label="主選單 第二類">
      <div class="container">
        <div class="logo" aria-label="網站標誌">
          <div class="mark" aria-hidden="true"></div>
          <span>示範元件</span>
        </div>
        <ul class="menu">
          <li><a href="https://accessibility.moda.gov.tw/Applications/Index/1?EnableId2=3">標章查詢</a></li>
          <li>
            <a href="https://accessibility.moda.gov.tw/Questions"
               class="menuButton"
               data-focus-mode="enter"
               aria-expanded="false"
               aria-controls="menuList-2"
               aria-label="常見問題">
              常見問題
            </a>
            <ul class="menuList" id="menuList-2" hidden>
              <li><a href="https://accessibility.moda.gov.tw/Questions/Category/18/1">標章申請及異動</a></li>
              <li><a href="https://accessibility.moda.gov.tw/Questions/Category/33/1">無障礙網頁規範</a></li>
              <li><a href="https://accessibility.moda.gov.tw/Questions/Category/19/1">網頁設計與規範要求</a></li>
              <li><a href="https://accessibility.moda.gov.tw/Questions/Category/20/1">Freego 檢測問題</a></li>
            </ul>
          </li>
          <li><a class="about-link" href="https://accessibility.moda.gov.tw/Applications/Index/1?EnableId2=3">關於無障礙</a></li>
          <li><a href="https://accessibility.moda.gov.tw/Download">下載專區</a></li>
        </ul>
      </div>
    </nav>
  </main>

  <script>
    (function(){
      var skip = document.querySelector('.skip-link');
      if (skip) {
        skip.addEventListener('click', function () {
          var target = document.getElementById('mainh1');
          if (!target) return;
          if (!target.hasAttribute('tabindex')) target.setAttribute('tabindex', '-1');
          target.focus({ preventScroll: true });
        });
      }
    })();

    const menus = [];
    document.querySelectorAll('.menu .menuButton').forEach((btn) => {
      const parentLi  = btn.closest('li');
      const listId    = btn.getAttribute('aria-controls');
      const list      = listId ? document.getElementById(listId) : parentLi?.querySelector('.menuList');
      const focusMode = btn.dataset.focusMode || 'enter'; // 'enter' or 'stay'
      if (!list || !parentLi) return;

      const setExpanded = (expanded) => {
        btn.setAttribute('aria-expanded', expanded ? 'true' : 'false');
        list.hidden = !expanded;
      };

      function openMenu({ moveFocus = false } = {}) {
        setExpanded(true);
        if (moveFocus && focusMode === 'enter') list.querySelector('a')?.focus();
      }

      function closeMenu({ returnFocusIfWithin = true } = {}) {
        const isOpen = btn.getAttribute('aria-expanded') === 'true';
        if (!isOpen) return;
        const focusTarget = document.activeElement;
        const focusIsWithin = (focusTarget === btn) || list.contains(focusTarget);
        setExpanded(false);
        if (returnFocusIfWithin && focusIsWithin) btn.focus();
      }

      btn.addEventListener('focus', () => {
        if (btn.getAttribute('aria-expanded') !== 'true') {
          openMenu({ moveFocus: false });
        }
      });

      parentLi.addEventListener('mouseenter', () => {
        if (btn.getAttribute('aria-expanded') !== 'true') {
          openMenu({ moveFocus: false });
        }
      });
      parentLi.addEventListener('mouseleave', () => {
        closeMenu({ returnFocusIfWithin: false });
      });

      menus.push({ btn, list, closeMenu, openMenu });
    });

    function getMenuByButton(button){
      return menus.find(m => m.btn === button);
    }

    document.querySelectorAll('.menu > li > a, .menu > li > button').forEach(topEl=>{
      topEl.addEventListener('keydown', (e)=>{
        if (e.key !== 'Tab' || !e.shiftKey) return;

        const li = topEl.closest('li');
        const prevLi = li?.previousElementSibling;
        if (!prevLi) return;

        const prevBtn = prevLi.querySelector('.menuButton');
        const prevListId = prevBtn?.getAttribute('aria-controls');
        const prevList = prevListId ? document.getElementById(prevListId) : prevLi.querySelector('.menuList');
        if (!prevBtn || !prevList) return;

        e.preventDefault();
        const menuObj = getMenuByButton(prevBtn);
        if (menuObj) {
          menuObj.openMenu({ moveFocus: false }); 
        } else {
          prevBtn.setAttribute('aria-expanded', 'true');
          prevList.hidden = false;
        }

        const links = prevList.querySelectorAll('a, button, [tabindex]:not([tabindex="-1"])');
        const lastFocusable = links[links.length - 1] || prevList.querySelector('a');
        lastFocusable?.focus();
      });
    });

    document.addEventListener('focusin', (e) => {
      const newlyFocused = e.target;
      menus.forEach(({ btn, list, closeMenu }) => {
        const withinThisGroup = (newlyFocused === btn) || list.contains(newlyFocused);
        if (!withinThisGroup) {
          closeMenu({ returnFocusIfWithin: false });
        }
      });
    });

    document.addEventListener('keydown', (e) => {
      if (e.key !== 'Escape') return;
      const activeEl = document.activeElement;
      menus.forEach(({ btn, list, closeMenu }) => {
        const focusWithin = (activeEl === btn) || list.contains(activeEl);
        closeMenu({ returnFocusIfWithin: focusWithin });
      });
    });

    document.addEventListener('click', (e) => {
      menus.forEach(({ btn, list, closeMenu }) => {
        if (!btn.contains(e.target) && !list.contains(e.target)) {
          closeMenu({ returnFocusIfWithin: false });
        }
      });
    });

    window.addEventListener('resize', () => {
      menus.forEach(({ closeMenu }) => closeMenu({ returnFocusIfWithin: false }));
    });
  </script>
</body>
</html>
